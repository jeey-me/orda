#!/usr/bin/env python3
"""
BigKinds í¬ë¡¤ëŸ¬ ëª¨ë“ˆ - FastAPI ì—°ë™ìš©
ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í´ë˜ìŠ¤ í˜•íƒœë¡œ ëª¨ë“ˆí™”
"""

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains
import time
import traceback
import json
import asyncio
from datetime import datetime
import os
import glob
from pathlib import Path
from typing import List, Dict, Optional

class BigKindsCrawler:
    """BigKinds ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ í´ë˜ìŠ¤"""
    
    def __init__(self, data_dir: str = "data2", headless: bool = False):
        """
        ì´ˆê¸°í™”
        
        Args:
            data_dir: ë°ì´í„° ì €ì¥ í´ë”
            headless: í—¤ë“œë¦¬ìŠ¤ ëª¨ë“œ ì—¬ë¶€ (ì„œë²„ í™˜ê²½ìš©)
        """
        self.data_dir = Path(data_dir)
        self.data_dir.mkdir(exist_ok=True)
        self.headless = headless
        self.driver = None
        self.wait = None
        
    def _setup_driver(self):
        """Chrome ë“œë¼ì´ë²„ ì„¤ì •"""
        options = webdriver.ChromeOptions()
        
        if self.headless:
            options.add_argument("--headless")
            options.add_argument("--no-sandbox")
            options.add_argument("--disable-dev-shm-usage")
        else:
            options.add_argument("--start-maximized")
            
        # ì¶”ê°€ ì•ˆì •ì„± ì˜µì…˜
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.add_experimental_option("excludeSwitches", ["enable-automation"])
        options.add_experimental_option('useAutomationExtension', False)
        
        self.driver = webdriver.Chrome(options=options)
        self.driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        self.wait = WebDriverWait(self.driver, 10)
        
    def _cleanup_driver(self):
        """ë“œë¼ì´ë²„ ì •ë¦¬"""
        if self.driver:
            try:
                self.driver.quit()
            except Exception as e:
                print(f"âš ï¸ ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {e}")
            finally:
                self.driver = None
                self.wait = None
    
    async def crawl_current_issues(self, max_issues: int = 10) -> Dict:
        """
        í˜„ì¬ ì´ìŠˆ í¬ë¡¤ë§ (ë¹„ë™ê¸°)
        
        Args:
            max_issues: í¬ë¡¤ë§í•  ìµœëŒ€ ì´ìŠˆ ìˆ˜
            
        Returns:
            í¬ë¡¤ë§ ê²°ê³¼ ë”•ì…”ë„ˆë¦¬
        """
        try:
            print(f"ğŸš€ BigKinds í¬ë¡¤ë§ ì‹œì‘ (ìµœëŒ€ {max_issues}ê°œ ì´ìŠˆ)")
            
            # ë“œë¼ì´ë²„ ì„¤ì •
            self._setup_driver()
            
            # 1. ì‚¬ì´íŠ¸ ì ‘ì†
            self.driver.get("https://www.bigkinds.or.kr/")
            await asyncio.sleep(2)
            
            # 2. ìŠ¤í¬ë¡¤ ì´ë™
            await self._scroll_to_issues_section()
            
            # 3. ì „ì²´ ì¹´í…Œê³ ë¦¬ í´ë¦­
            await self._click_category_all()
            
            # 4. ì´ìŠˆë“¤ í¬ë¡¤ë§
            results = await self._crawl_issues(max_issues)
            
            # 5. ê²°ê³¼ ì €ì¥
            saved_file = self.save_to_json(results)
            
            return {
                "crawled_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "total_issues": len(results),
                "source": "bigkinds.or.kr",
                "category": "ì „ì²´",
                "issues": results,
                "saved_file": saved_file
            }
            
        except Exception as e:
            print(f"âŒ í¬ë¡¤ë§ ì‹¤íŒ¨: {e}")
            traceback.print_exc()
            raise
        finally:
            self._cleanup_driver()
    
    async def _scroll_to_issues_section(self):
        """ì´ìŠˆ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤"""
        try:
            self.driver.execute_script("window.scrollTo(0, 880);")
            await asyncio.sleep(1)
            print("âœ… ìŠ¤í¬ë¡¤ ì´ë™ ì™„ë£Œ")
        except Exception as e:
            print("âŒ ìŠ¤í¬ë¡¤ ì´ë™ ì‹¤íŒ¨")
            raise
    
    async def _click_category_all(self):
        """ì „ì²´ ì¹´í…Œê³ ë¦¬ í´ë¦­"""
        try:
            category_button = self.wait.until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, 'a.issue-category[data-category="ì „ì²´"]'))
            )
            self.driver.execute_script("arguments[0].click();", category_button)
            print("âœ… ì¹´í…Œê³ ë¦¬ í´ë¦­ ì™„ë£Œ")
            await asyncio.sleep(3)
        except Exception as e:
            print("âŒ ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹¤íŒ¨")
            raise
    
    async def _crawl_issues(self, max_issues: int) -> List[Dict]:
        """ê°œë³„ ì´ìŠˆë“¤ í¬ë¡¤ë§"""
        results = []
        
        for i in range(1, max_issues + 1):
            print(f"â–¶ï¸ {i}ë²ˆ ì´ìŠˆ ì²˜ë¦¬ ì‹œì‘")
            try:
                # ìŠ¬ë¼ì´ë“œ ë„˜ê¸°ê¸° (4ë²ˆë¶€í„°)
                if i >= 3:
                    await self._navigate_slides(i)
                
                # ì´ìŠˆ í´ë¦­ ë° ë°ì´í„° ì¶”ì¶œ
                issue_data = await self._extract_issue_data(i)
                if issue_data:
                    results.append(issue_data)
                
                # íŒì—… ë‹«ê¸° ë° ìŠ¤í¬ë¡¤ ë³µì›
                await self._close_popup_and_restore()
                
            except Exception as e:
                print(f"âŒ {i}ë²ˆ ì´ìŠˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                # ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ ì´ìŠˆ ê³„ì† ì²˜ë¦¬
                continue
        
        return results
    
    async def _navigate_slides(self, issue_num: int):
        """ìŠ¬ë¼ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜"""
        for _ in range(issue_num - 3):
            try:
                next_btn = self.driver.find_element(
                    By.CSS_SELECTOR, 'div.swiper-button-next.section2-btn.st2-sw1-next'
                )
                is_disabled = next_btn.get_attribute('aria-disabled') == 'true'
                if is_disabled:
                    break
                    
                self.driver.execute_script("arguments[0].click();", next_btn)
                await asyncio.sleep(0.8)
            except Exception as e:
                print(f"âš ï¸ ìŠ¬ë¼ì´ë“œ ë„˜ê¸°ê¸° ì¤‘ ì˜¤ë¥˜: {e}")
                break
    
    async def _extract_issue_data(self, issue_num: int) -> Optional[Dict]:
        """ê°œë³„ ì´ìŠˆ ë°ì´í„° ì¶”ì¶œ"""
        try:
            # ì´ìŠˆ í´ë¦­
            issue_selector = f'div.swiper-slide:nth-child({issue_num}) .issue-item-link'
            issue_element = self.wait.until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, issue_selector))
            )
            self.driver.execute_script("arguments[0].scrollIntoView(true);", issue_element)
            self.driver.execute_script("arguments[0].click();", issue_element)
            
            # íŒì—… ë‚´ìš© ì¶”ì¶œ
            title_elem = self.wait.until(
                EC.presence_of_element_located((By.CSS_SELECTOR, 'p.issuPopTitle'))
            )
            content_elem = self.wait.until(
                EC.presence_of_element_located((By.CSS_SELECTOR, 'p.pT20.issuPopContent'))
            )
            
            title = title_elem.text.strip()
            content = content_elem.text.strip()
            
            return {
                "ì´ìŠˆë²ˆí˜¸": issue_num,
                "ì œëª©": title,
                "ë‚´ìš©": content,
                "ì¶”ì¶œì‹œê°„": datetime.now().isoformat()
            }
            
        except Exception as e:
            print(f"âŒ ì´ìŠˆ {issue_num} ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨: {e}")
            return None
    
    async def _close_popup_and_restore(self):
        """íŒì—… ë‹«ê¸° ë° í™”ë©´ ë³µì›"""
        try:
            # íŒì—… ë‹«ê¸°
            ActionChains(self.driver).send_keys(Keys.ESCAPE).perform()
            await asyncio.sleep(1)
            
            # ìŠ¤í¬ë¡¤ ë³µì›
            self.driver.execute_script("window.scrollTo(0, 880);")
            await asyncio.sleep(1)
            
        except Exception as e:
            print(f"âš ï¸ íŒì—… ë‹«ê¸° ì‹¤íŒ¨: {e}")
    
    def save_to_json(self, data: List[Dict]) -> str:
        """í¬ë¡¤ë§ ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥"""
        try:
            timestamp = datetime.now().strftime("%Y.%m.%d_%H.%M.%S")
            filename = f"{timestamp}_BigKinds_current_issues.json"
            filepath = self.data_dir / filename
            
            save_data = {
                "crawled_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "total_issues": len(data),
                "source": "bigkinds.or.kr",
                "category": "ì „ì²´",
                "issues": data
            }
            
            with open(filepath, 'w', encoding='utf-8') as f:
                json.dump(save_data, f, ensure_ascii=False, indent=2)
            
            print(f"âœ… JSON ì €ì¥ ì™„ë£Œ: {filepath}")
            print(f"ğŸ“Š ì €ì¥ëœ ì´ìŠˆ ìˆ˜: {len(data)}ê°œ")
            
            return str(filepath)
            
        except Exception as e:
            print(f"âŒ JSON ì €ì¥ ì‹¤íŒ¨: {e}")
            raise
    
    def load_latest_issues(self) -> Optional[Dict]:
        """ìµœì‹  í¬ë¡¤ë§ ë°ì´í„° ë¡œë“œ"""
        try:
            # data2 í´ë”ì—ì„œ ìµœì‹  JSON íŒŒì¼ ì°¾ê¸°
            json_files = list(self.data_dir.glob("*_BigKinds_current_issues.json"))
            
            if not json_files:
                print("ğŸ“‚ ì €ì¥ëœ í¬ë¡¤ë§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return None
            
            # ê°€ì¥ ìµœì‹  íŒŒì¼ ì„ íƒ
            latest_file = max(json_files, key=lambda f: f.stat().st_mtime)
            
            with open(latest_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            print(f"âœ… ìµœì‹  ë°ì´í„° ë¡œë“œ: {latest_file.name}")
            print(f"ğŸ“Š ì´ìŠˆ ìˆ˜: {data['total_issues']}ê°œ")
            print(f"ğŸ• í¬ë¡¤ë§ ì‹œê°„: {data['crawled_at']}")
            
            return data
            
        except Exception as e:
            print(f"âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
            return None
    
    def load_from_json(self, filepath: str) -> Optional[List[Dict]]:
        """íŠ¹ì • JSON íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ"""
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            print(f"âœ… JSON ë¡œë“œ ì™„ë£Œ: {filepath}")
            print(f"ğŸ“Š ë¡œë“œëœ ì´ìŠˆ ìˆ˜: {data['total_issues']}ê°œ")
            
            return data['issues']
            
        except Exception as e:
            print(f"âŒ JSON ë¡œë“œ ì‹¤íŒ¨: {e}")
            return None
    
    async def crawl_and_update(self):
        """í¬ë¡¤ë§ + Pinecone ì—…ë°ì´íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ìš©)"""
        try:
            # 1. ìƒˆë¡œìš´ ì´ìŠˆ í¬ë¡¤ë§
            result = await self.crawl_current_issues()
            
            # 2. Pinecone ë²¡í„° ì—…ë°ì´íŠ¸ (ì˜µì…˜)
            # from .vector_search import VectorSearchEngine
            # vector_engine = VectorSearchEngine()
            # await vector_engine.update_current_issues(result['issues'])
            
            print("ğŸ”„ í¬ë¡¤ë§ ë° ë²¡í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ")
            return result
            
        except Exception as e:
            print(f"âŒ í¬ë¡¤ë§ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")
            raise

# ===== í…ŒìŠ¤íŠ¸ ë° ì§ì ‘ ì‹¤í–‰ìš© =====

async def main():
    """í…ŒìŠ¤íŠ¸ìš© ë©”ì¸ í•¨ìˆ˜"""
    crawler = BigKindsCrawler(headless=False)  # GUI ëª¨ë“œë¡œ í…ŒìŠ¤íŠ¸
    
    try:
        # í¬ë¡¤ë§ ì‹¤í–‰
        result = await crawler.crawl_current_issues(max_issues=5)  # í…ŒìŠ¤íŠ¸ìš© 5ê°œë§Œ
        
        print("\n" + "="*60)
        print("ğŸ“Š í¬ë¡¤ë§ ê²°ê³¼:")
        for issue in result['issues']:
            print(f"â€¢ {issue['ì œëª©']}")
        
        # ìµœì‹  ë°ì´í„° ë¡œë“œ í…ŒìŠ¤íŠ¸
        print("\n" + "="*60)
        print("ğŸ“‚ ìµœì‹  ë°ì´í„° ë¡œë“œ í…ŒìŠ¤íŠ¸:")
        latest = crawler.load_latest_issues()
        if latest:
            print(f"âœ… ë¡œë“œ ì„±ê³µ: {latest['total_issues']}ê°œ ì´ìŠˆ")
        
    except Exception as e:
        print(f"âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")

if __name__ == "__main__":
    # ì§ì ‘ ì‹¤í–‰ ì‹œ í…ŒìŠ¤íŠ¸
    print("ğŸ§ª BigKinds í¬ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ëª¨ë“œ")
    asyncio.run(main())